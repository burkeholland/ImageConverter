name: Build and Release

on:
  push:
    branches: [master]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Get current version
        id: get_version
        shell: pwsh
        run: |
          # Get the latest tag, default to v0.0.0 if none exists
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) {
            $latestTag = "v0.0.0"
          }
          
          # Parse version
          $version = $latestTag -replace '^v', ''
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          
          # Determine bump type
          $bumpType = "${{ github.event.inputs.version_bump }}"
          if (-not $bumpType) {
            $bumpType = "patch"
          }
          
          # Bump version
          switch ($bumpType) {
            "major" { $major++; $minor = 0; $patch = 0 }
            "minor" { $minor++; $patch = 0 }
            "patch" { $patch++ }
          }
          
          $newVersion = "$major.$minor.$patch"
          $newTag = "v$newVersion"
          
          Write-Host "Previous: $latestTag -> New: $newTag"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$newVersion"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "tag=$newTag"

      - name: Update version in project
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $csprojPath = "ImageConverter.App/ImageConverter.App.csproj"
          $content = Get-Content $csprojPath -Raw
          
          # Update or add version properties
          if ($content -match '<Version>') {
            $content = $content -replace '<Version>[^<]*</Version>', "<Version>$version</Version>"
          } else {
            $content = $content -replace '(<PropertyGroup>)', "`$1`n    <Version>$version</Version>"
          }
          
          if ($content -match '<FileVersion>') {
            $content = $content -replace '<FileVersion>[^<]*</FileVersion>', "<FileVersion>$version.0</FileVersion>"
          } else {
            $content = $content -replace '(<Version>[^<]*</Version>)', "`$1`n    <FileVersion>$version.0</FileVersion>"
          }
          
          if ($content -match '<AssemblyVersion>') {
            $content = $content -replace '<AssemblyVersion>[^<]*</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
          } else {
            $content = $content -replace '(<FileVersion>[^<]*</FileVersion>)', "`$1`n    <AssemblyVersion>$version.0</AssemblyVersion>"
          }
          
          Set-Content $csprojPath $content
          Write-Host "Updated project version to $version"

      - name: Restore dependencies
        run: dotnet restore ImageConverter.App/ImageConverter.App.csproj

      - name: Build
        run: dotnet build ImageConverter.App/ImageConverter.App.csproj -c Release --no-restore

      - name: Publish
        run: dotnet publish ImageConverter.App/ImageConverter.App.csproj -c Release -r win-x64 --self-contained true -o publish

      - name: Create installer package
        shell: pwsh
        run: |
          # Create release folder
          New-Item -ItemType Directory -Path "release" -Force
          
          # Copy executable
          Copy-Item "publish/ImageConverter.exe" -Destination "release/"
          
          # Copy installer scripts
          Copy-Item "Installer/Install.bat" -Destination "release/"
          Copy-Item "Installer/Install.ps1" -Destination "release/"
          Copy-Item "Installer/Uninstall.bat" -Destination "release/"
          Copy-Item "Installer/Uninstall.ps1" -Destination "release/"
          Copy-Item "Installer/EnableClassicMenu.bat" -Destination "release/"
          
          # Create ZIP
          Compress-Archive -Path "release/*" -DestinationPath "ImageConverter-${{ steps.get_version.outputs.tag }}.zip"
          
          Write-Host "Created ImageConverter-${{ steps.get_version.outputs.tag }}.zip"

      - name: Create Git tag
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.get_version.outputs.tag }}
          git push origin ${{ steps.get_version.outputs.tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Image Converter ${{ steps.get_version.outputs.tag }}
          body: |
            ## Image Converter ${{ steps.get_version.outputs.tag }}
            
            ### Installation
            1. Download `ImageConverter-${{ steps.get_version.outputs.tag }}.zip`
            2. Extract to a folder
            3. Right-click `Install.bat` → **Run as administrator**
            
            ### What's Included
            - `ImageConverter.exe` - The main application
            - `Install.bat` - Installer (run as admin)
            - `Uninstall.bat` - Uninstaller (run as admin)
            - `EnableClassicMenu.bat` - Enable Windows 11 classic context menu (optional)
            
            ### Features
            - Right-click any image → "Convert Image..."
            - Convert between JPEG, PNG, WebP, GIF, BMP, TIFF, ICO
            - Quality and size controls
            - Modern Windows 11 UI with system theme support
          files: |
            ImageConverter-${{ steps.get_version.outputs.tag }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-and-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
